// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
  binaryTargets   = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

enum AccountType {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  PENDING
  AUTHORIZED
  PAUSED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
}

enum InitiatorType {
  OWNER
  EMPLOYEE
  SYSTEM
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
}

enum AttributeType {
  TEXT
  NUMBER
  COLOR
  IMAGE
}

model User {
  id         String   @id @default(cuid())
  supabaseId String   @unique @map("supabase_user_id")
  email      String   @unique
  username   String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  stores       Store[]
  subscription Subscription?

  @@index([email])
  @@map("users")
}

model Subscription {
  id                       String             @id @default(cuid())
  userId                   String             @unique @map("user_id")
  accountType              AccountType        @map("account_type")

  // 1.2 MercadoPago fields
  mercadopagoPreapprovalId String?            @map("mercadopago_preapproval_id")
  status                   SubscriptionStatus @default(PENDING)
  nextBillingDate          DateTime?          @map("next_billing_date")

  createdAt                DateTime           @default(now()) @map("created_at")
  updatedAt                DateTime           @updatedAt @map("updated_at")

  // Relations (1.7)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments        Payment[]
  planChangeLogs  PlanChangeLog[]

  // Indexes (1.2)
  @@index([userId])
  @@index([mercadopagoPreapprovalId])
  @@map("subscriptions")
}

model Store {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  subdomain   String   @unique
  ownerId     String   @map("owner_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  owner    User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([subdomain])
  @@index([ownerId])
  @@map("stores")
}

model Product {
  id              String        @id @default(cuid())
  name            String
  description     String?       @db.Text
  slug            String
  brand           String?
  status          ProductStatus @default(DRAFT)
  isDigital       Boolean       @default(false) @map("is_digital")
  isFeatured      Boolean       @default(false) @map("is_featured")
  isNew           Boolean       @default(false) @map("is_new")
  isOnSale        Boolean       @default(false) @map("is_on_sale")
  allowPromotions Boolean       @default(true) @map("allow_promotions")
  trackInventory  Boolean       @default(true) @map("track_inventory")

  // SEO fields
  seoTitle        String?       @map("seo_title") @db.VarChar(60)
  seoDescription  String?       @map("seo_description") @db.VarChar(160)
  urlSlug         String?       @map("url_slug")
  ogImageUrl      String?       @map("og_image_url")

  // Foreign keys
  storeId         String        @map("store_id")

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  store           Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  attributes      ProductAttribute[]
  variants        ProductVariant[]

  @@index([storeId])
  @@index([slug])
  @@index([status])
  @@map("products")
}

model ProductAttribute {
  id        String        @id @default(cuid())
  name      String
  type      AttributeType
  productId String        @map("product_id")

  // Timestamps
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  // Relations
  product   Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  values    ProductAttributeValue[]

  @@index([productId])
  @@map("product_attributes")
}

model ProductAttributeValue {
  id          String @id @default(cuid())
  value       String
  attributeId String @map("attribute_id")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  attribute   ProductAttribute        @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  variantAttributeValues VariantAttributeValue[]

  @@index([attributeId])
  @@map("product_attribute_values")
}

model ProductVariant {
  id               String   @id @default(cuid())
  sku              String   @unique
  price            Decimal  @db.Decimal(10, 2)
  promotionalPrice Decimal? @map("promotional_price") @db.Decimal(10, 2)
  cost             Decimal? @db.Decimal(10, 2)
  productId        String   @map("product_id")

  // Timestamps
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  product          Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributeValues  VariantAttributeValue[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model VariantAttributeValue {
  variantId        String @map("variant_id")
  attributeValueId String @map("attribute_value_id")

  // Relations
  variant          ProductVariant        @relation(fields: [variantId], references: [id], onDelete: Cascade)
  attributeValue   ProductAttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)

  @@id([variantId, attributeValueId])
  @@index([variantId])
  @@index([attributeValueId])
  @@map("variant_attribute_values")
}

model Payment {
  id                    String        @id @default(cuid())
  subscriptionId        String        @map("subscription_id")
  mercadopagoPaymentId  String        @unique @map("mercadopago_payment_id")
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("ARS")
  status                PaymentStatus
  paidAt                DateTime?     @map("paid_at")

  // AFIP-ready fields
  cuit                  String?
  ivaAmount             Decimal?      @map("iva_amount") @db.Decimal(10, 2)
  netAmount             Decimal?      @map("net_amount") @db.Decimal(10, 2)
  caeCode               String?       @map("cae_code")

  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  // Relations
  subscription          Subscription  @relation(fields: [subscriptionId], references: [id])
  invoice               Invoice?

  @@index([subscriptionId])
  @@index([mercadopagoPaymentId])
  @@map("payments")
}

model Invoice {
  id                 String    @id @default(cuid())
  paymentId          String    @unique @map("payment_id")
  invoiceNumber      String    @unique @map("invoice_number")
  issuedAt           DateTime  @map("issued_at")
  customerName       String    @map("customer_name")
  customerEmail      String    @map("customer_email")

  // AFIP-ready fields
  customerCuit       String?   @map("customer_cuit")
  subtotal           Decimal   @db.Decimal(10, 2)
  ivaAmount          Decimal   @map("iva_amount") @db.Decimal(10, 2)
  total              Decimal   @db.Decimal(10, 2)
  caeCode            String?   @map("cae_code")
  caeExpirationDate  DateTime? @map("cae_expiration_date")

  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  payment            Payment   @relation(fields: [paymentId], references: [id])

  @@index([paymentId])
  @@index([invoiceNumber])
  @@map("invoices")
}

model PlanChangeLog {
  id             String        @id @default(cuid())
  subscriptionId String        @map("subscription_id")
  previousPlan   AccountType   @map("previous_plan")
  newPlan        AccountType   @map("new_plan")
  changedAt      DateTime      @default(now()) @map("changed_at")

  // Initiator tracking
  initiatorType  InitiatorType @map("initiator_type")
  initiatorId    String?       @map("initiator_id")

  createdAt      DateTime      @default(now()) @map("created_at")

  // Relations
  subscription   Subscription  @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@map("plan_change_logs")
}
